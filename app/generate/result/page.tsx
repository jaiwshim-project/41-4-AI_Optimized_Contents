'use client';

import { useState, useRef, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import ApiKeyPanel from '@/components/ApiKeyPanel';
import type { ContentCategory, GenerateResponse } from '@/lib/types';
import { addRevision, generateId } from '@/lib/history';
import { uploadImage, getGenerateResult, saveGenerateResult, type GenerateResultData } from '@/lib/supabase-storage';

const categories: { id: ContentCategory; label: string }[] = [
  { id: 'blog', label: 'ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸' },
  { id: 'product', label: 'ì œí’ˆ ì„¤ëª…' },
  { id: 'faq', label: 'FAQ í˜ì´ì§€' },
  { id: 'howto', label: 'How-to ê°€ì´ë“œ' },
  { id: 'landing', label: 'ëœë”© í˜ì´ì§€' },
  { id: 'technical', label: 'ê¸°ìˆ  ë¬¸ì„œ' },
  { id: 'social', label: 'ì†Œì…œ ë¯¸ë””ì–´' },
  { id: 'email', label: 'ì´ë©”ì¼ ë§ˆì¼€íŒ…' },
];

interface StoredResult {
  result: GenerateResponse;
  category: ContentCategory;
  topic: string;
  targetKeyword: string;
  tone: string;
  historyId: string;
}

export default function GenerateResultPage() {
  const router = useRouter();
  const [showApiKeyInput, setShowApiKeyInput] = useState(false);
  const [result, setResult] = useState<GenerateResponse | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<ContentCategory | null>(null);
  const [topic, setTopic] = useState('');
  const [targetKeyword, setTargetKeyword] = useState('');
  const [tone, setTone] = useState('');
  const [currentHistoryId, setCurrentHistoryId] = useState<string | null>(null);

  const [copied, setCopied] = useState(false);
  const [copiedTitle, setCopiedTitle] = useState(false);
  const [copiedContent, setCopiedContent] = useState(false);
  const [copiedImage, setCopiedImage] = useState(false);
  const [isCapturing, setIsCapturing] = useState(false);
  const [showEditInput, setShowEditInput] = useState(false);
  const [editNotes, setEditNotes] = useState('');
  const [isRegenerating, setIsRegenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [generatedImages, setGeneratedImages] = useState<string[]>([]);
  const [isGeneratingImages, setIsGeneratingImages] = useState(false);
  const [imageError, setImageError] = useState<string | null>(null);

  const [showFinalContent, setShowFinalContent] = useState(false);
  const [finalContentHtml, setFinalContentHtml] = useState('');
  const [copiedFinal, setCopiedFinal] = useState(false);
  const finalContentRef = useRef<HTMLDivElement>(null);
  const contentRef = useRef<HTMLDivElement>(null);

  // SNS ë³€í™˜
  const [snsChannel, setSnsChannel] = useState<string | null>(null);
  const [snsResult, setSnsResult] = useState<string | null>(null);
  const [snsLoading, setSnsLoading] = useState(false);
  const [snsCopied, setSnsCopied] = useState(false);

  // A/B ë²„ì „
  const [abVersions, setAbVersions] = useState<(GenerateResponse & { toneName?: string })[]>([]);
  const [activeAbTab, setActiveAbTab] = useState(0);

  // Supabase ë˜ëŠ” localStorageì—ì„œ ê²°ê³¼ ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (!id) {
      router.push('/generate');
      return;
    }
    getGenerateResult(id).then(data => {
      if (!data) {
        router.push('/generate');
        return;
      }
      setResult(data.result);
      setSelectedCategory(data.category);
      setTopic(data.topic);
      setTargetKeyword(data.targetKeyword);
      setTone(data.tone);
      setCurrentHistoryId(data.historyId);
      // A/B ë²„ì „ì´ ìˆìœ¼ë©´ ë¡œë“œ
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      if ((data.result as any)?.abVersions) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        setAbVersions((data.result as any).abVersions);
      }
    });
  }, [router]);

  const handleSnsConvert = async (channel: string) => {
    if (!result?.content) return;
    setSnsChannel(channel);
    setSnsLoading(true);
    setSnsResult(null);
    try {
      const res = await fetch('/api/convert-content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: result.content, channel, title: result.title }),
      });
      if (!res.ok) throw new Error('ë³€í™˜ ì‹¤íŒ¨');
      const data = await res.json();
      setSnsResult(data.result);
    } catch {
      setSnsResult('ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setSnsLoading(false);
    }
  };

  const handleCopySns = async () => {
    if (!snsResult) return;
    await navigator.clipboard.writeText(snsResult);
    setSnsCopied(true);
    setTimeout(() => setSnsCopied(false), 2000);
  };

  const handleCopyTitle = async () => {
    if (!result) return;
    await navigator.clipboard.writeText(result.title);
    setCopiedTitle(true);
    setTimeout(() => setCopiedTitle(false), 2000);
  };

  const handleCopy = async () => {
    if (!contentRef.current) return;
    try {
      const htmlBlob = new Blob([contentRef.current.innerHTML], { type: 'text/html' });
      const textBlob = new Blob([contentRef.current.innerText], { type: 'text/plain' });
      await navigator.clipboard.write([
        new ClipboardItem({
          'text/html': htmlBlob,
          'text/plain': textBlob,
        }),
      ]);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {
      if (contentRef.current) {
        await navigator.clipboard.writeText(contentRef.current.innerText);
      }
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  const handleCopyAsImage = async () => {
    if (!contentRef.current) return;
    setIsCapturing(true);
    try {
      const html2canvas = (await import('html2canvas')).default;
      const canvas = await html2canvas(contentRef.current, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true,
        logging: false,
      });
      const dataUrl = canvas.toDataURL('image/png');
      const res = await fetch(dataUrl);
      const blob = await res.blob();

      try {
        await navigator.clipboard.write([
          new ClipboardItem({
            [blob.type]: blob,
          }),
        ]);
        setCopiedImage(true);
        setTimeout(() => setCopiedImage(false), 2000);
      } catch {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `content-${Date.now()}.png`;
        a.click();
        URL.revokeObjectURL(url);
        setCopiedImage(true);
        setTimeout(() => setCopiedImage(false), 2000);
      }
    } catch (err) {
      console.error('Image capture error:', err);
    } finally {
      setIsCapturing(false);
    }
  };

  const handleRegenerate = async () => {
    if (!selectedCategory || !result || !editNotes.trim()) return;
    setIsRegenerating(true);
    setError(null);

    try {
      const response = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category: selectedCategory,
          topic: topic.trim(),
          targetKeyword: targetKeyword.trim() || undefined,
          tone,
          additionalNotes: `ê¸°ì¡´ ìƒì„±ëœ ì½˜í…ì¸ ë¥¼ ì•„ë˜ ìˆ˜ì • ìš”ì²­ì— ë”°ë¼ ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n[ìˆ˜ì •/ì¶”ê°€ ìš”ì²­]\n${editNotes.trim()}\n\n[ê¸°ì¡´ ì½˜í…ì¸ ]\n${result.content}`,
        }),
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || 'ì½˜í…ì¸  ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

      const data = await response.json();
      setResult(data);
      // Supabaseì— ì—…ë°ì´íŠ¸
      const params = new URLSearchParams(window.location.search);
      const resultId = params.get('id');
      if (resultId) {
        await saveGenerateResult({
          result: data,
          category: selectedCategory!,
          topic,
          targetKeyword,
          tone,
          historyId: currentHistoryId || '',
        });
      }
      // ìˆ˜ì • ì´ë ¥ ì €ì¥
      if (currentHistoryId) {
        const now = new Date();
        await addRevision(currentHistoryId, {
          id: generateId(),
          date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
          editNotes: editNotes.trim(),
          result: data,
        });
      }
      setEditNotes('');
      setShowEditInput(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsRegenerating(false);
    }
  };

  const handleGenerateImages = async () => {
    if (!result) return;
    setIsGeneratingImages(true);
    setImageError(null);
    try {
      const geminiKey = (await (await import('@/lib/supabase-storage')).getApiKey('gemini')) || '';
      const response = await fetch('/api/generate-images', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: result.content, title: result.title, geminiApiKey: geminiKey }),
      });
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      const data = await response.json();
      if (currentHistoryId && data.images) {
        const uploadedUrls = await Promise.all(
          data.images.map((img: string) => uploadImage(currentHistoryId, img, result.title))
        );
        setGeneratedImages(uploadedUrls);
      } else {
        setGeneratedImages(data.images);
      }
    } catch (err) {
      setImageError(err instanceof Error ? err.message : 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsGeneratingImages(false);
    }
  };

  const parseTable = (block: string): string => {
    const lines = block.trim().split('\n').filter(l => l.trim().startsWith('|'));
    if (lines.length < 2) return '';
    const parseCells = (line: string) =>
      line.split('|').slice(1, -1).map(c => c.trim());
    const headers = parseCells(lines[0]);
    const startIdx = /^[\s|:-]+$/.test(lines[1]) ? 2 : 1;
    const rows = lines.slice(startIdx).map(parseCells);
    const thStyle = 'padding:10px 16px;text-align:left;font-weight:600;font-size:0.85em;color:#ffffff;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:1px solid #818cf8;white-space:nowrap';
    const tdBaseStyle = 'padding:10px 16px;font-size:0.85em;border:1px solid #e5e7eb;color:#374151';
    let html = '<table style="width:100%;border-collapse:collapse;margin:20px 0;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08)">';
    html += '<thead><tr>' + headers.map(h => `<th style="${thStyle}">${h.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</th>`).join('') + '</tr></thead>';
    html += '<tbody>';
    rows.forEach((row, i) => {
      const bg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
      html += '<tr>' + row.map(cell => `<td style="${tdBaseStyle};background:${bg}">${cell.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</td>`).join('') + '</tr>';
    });
    html += '</tbody></table>';
    return html;
  };

  const markdownToHtml = (text: string) => {
    const paragraphs = text.split(/\n\n+/);
    let h2Index = 0;
    const sectionColors = [
      { bg: '#eef2ff', border: '#818cf8', accent: '#4f46e5', gradient: 'linear-gradient(135deg, #6366f1, #818cf8)' },
      { bg: '#ecfdf5', border: '#6ee7b7', accent: '#059669', gradient: 'linear-gradient(135deg, #10b981, #34d399)' },
      { bg: '#fef3c7', border: '#fbbf24', accent: '#d97706', gradient: 'linear-gradient(135deg, #f59e0b, #fbbf24)' },
      { bg: '#fce7f3', border: '#f9a8d4', accent: '#db2777', gradient: 'linear-gradient(135deg, #ec4899, #f9a8d4)' },
      { bg: '#e0e7ff', border: '#a5b4fc', accent: '#4338ca', gradient: 'linear-gradient(135deg, #6366f1, #a5b4fc)' },
      { bg: '#f0fdf4', border: '#86efac', accent: '#16a34a', gradient: 'linear-gradient(135deg, #22c55e, #86efac)' },
      { bg: '#fff7ed', border: '#fdba74', accent: '#ea580c', gradient: 'linear-gradient(135deg, #f97316, #fdba74)' },
      { bg: '#fdf2f8', border: '#f9a8d4', accent: '#be185d', gradient: 'linear-gradient(135deg, #ec4899, #f9a8d4)' },
    ];
    return paragraphs.map(para => {
      const lines = para.trim().split('\n');
      if (lines.length >= 2 && lines[0].trim().startsWith('|') && lines[1].trim().startsWith('|')) {
        return parseTable(para);
      }
      let html = para;
      // H2 with colored accent bar
      html = html.replace(/^## (.*$)/gm, (_match, title) => {
        const color = sectionColors[h2Index % sectionColors.length];
        h2Index++;
        return `<div style="margin:36px 0 16px;padding:12px 20px;background:${color.bg};border-left:4px solid ${color.border};border-radius:0 12px 12px 0"><h2 style="font-size:1.2em;font-weight:700;color:${color.accent};margin:0">${title}</h2></div>`;
      });
      // H3 with subtle style
      html = html
        .replace(/^### (.*$)/gm, '<h3 style="font-size:1.05em;font-weight:700;color:#374151;margin:24px 0 8px;padding-left:12px;border-left:3px solid #c7d2fe">$1</h3>')
        .replace(/^# (.*$)/gm, '<h1 style="font-size:1.5em;font-weight:800;background:linear-gradient(135deg,#4f46e5,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:32px 0 16px">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#1e293b">$1</strong>')
        .replace(/^\- (.*$)/gm, '<li style="margin-left:20px;list-style:none;margin-bottom:6px;padding-left:8px;position:relative"><span style="position:absolute;left:-14px;color:#6366f1;font-weight:bold">&#8226;</span>$1</li>')
        .replace(/^\d+\. (.*$)/gm, '<li style="margin-left:20px;list-style:decimal;margin-bottom:6px;padding-left:4px;color:#374151">$1</li>')
        .replace(/^> (.*$)/gm, '<blockquote style="border-left:4px solid #818cf8;padding:12px 20px;margin:16px 0;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border-radius:0 12px 12px 0;color:#374151;font-style:italic">$1</blockquote>');
      const trimmed = html.trim();
      const isBlock = /^<(h[1-6]|li|blockquote|ul|ol|figure|div|table)/.test(trimmed);
      if (isBlock) return html;
      html = html.replace(/\n/g, '<br>');
      return `<p style="margin-bottom:1em;line-height:1.9;color:#374151">${html}</p>`;
    }).join('');
  };

  const handleApplyImages = () => {
    if (!result || generatedImages.length === 0) return;

    const lines = result.content.split('\n');
    const headingIndices: number[] = [];
    lines.forEach((line, i) => {
      if (/^#{1,3}\s/.test(line)) headingIndices.push(i);
    });

    let insertPositions: number[];
    if (headingIndices.length >= 4) {
      const mid = Math.floor(headingIndices.length / 2);
      insertPositions = [
        headingIndices[1],
        headingIndices[mid],
        headingIndices[headingIndices.length - 1],
      ];
    } else {
      const step = Math.floor(lines.length / (generatedImages.length + 1));
      insertPositions = generatedImages.map((_, i) => step * (i + 1));
    }

    insertPositions = [...new Set(insertPositions)].sort((a, b) => a - b);

    const imageLabels = ['í•µì‹¬ ìš”ì•½ ì¸í¬ê·¸ë˜í”½', 'í”„ë¡œì„¸ìŠ¤ ì¸í¬ê·¸ë˜í”½', 'ë°ì´í„° ì¸í¬ê·¸ë˜í”½'];
    const imageTags = generatedImages.map((img, i) =>
      `\n<figure style="text-align:center;margin:32px 0"><img src="${img}" alt="${imageLabels[i] || `ì¸í¬ê·¸ë˜í”½ ${i+1}`}" style="width:100%;max-width:720px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)" /><figcaption style="font-size:0.85em;color:#6b7280;margin-top:8px">${imageLabels[i] || `ì¸í¬ê·¸ë˜í”½ ${i+1}`}</figcaption></figure>\n`
    );

    const resultLines: string[] = [];
    let imgIdx = 0;
    for (let i = 0; i < lines.length; i++) {
      if (imgIdx < insertPositions.length && i === insertPositions[imgIdx]) {
        resultLines.push(imageTags[imgIdx] || '');
        imgIdx++;
      }
      resultLines.push(lines[i]);
    }
    while (imgIdx < imageTags.length) {
      resultLines.push(imageTags[imgIdx]);
      imgIdx++;
    }

    const mergedContent = resultLines.join('\n');
    const html = markdownToHtml(mergedContent);

    let fullHtml = `<h1 style="font-size:1.8em;font-weight:bold;color:#1a1a1a;margin-bottom:16px">${result.title}</h1>\n${html}`;
    if (result.hashtags && result.hashtags.length > 0) {
      const tags = result.hashtags.map(t => t.startsWith('#') ? t : `#${t}`).join(' ');
      fullHtml += `\n<p style="margin-top:24px;color:#6366f1;font-size:0.9em">${tags}</p>`;
    }

    setFinalContentHtml(fullHtml);
    setShowFinalContent(true);
  };

  const handleCopyFinalContent = async () => {
    if (!finalContentRef.current) return;
    try {
      const htmlBlob = new Blob([finalContentRef.current.innerHTML], { type: 'text/html' });
      const textBlob = new Blob([finalContentRef.current.innerText], { type: 'text/plain' });
      await navigator.clipboard.write([
        new ClipboardItem({
          'text/html': htmlBlob,
          'text/plain': textBlob,
        }),
      ]);
      setCopiedFinal(true);
      setTimeout(() => setCopiedFinal(false), 2000);
    } catch {
      await navigator.clipboard.writeText(finalContentRef.current.innerText);
      setCopiedFinal(true);
      setTimeout(() => setCopiedFinal(false), 2000);
    }
  };

  const handleReset = () => {
    router.push('/generate');
  };

  if (!result) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="w-12 h-12 relative">
          <div className="absolute inset-0 rounded-full border-4 border-blue-100" />
          <div className="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin" />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header
        showApiKeyButton
        onToggleApiKey={() => setShowApiKeyInput(!showApiKeyInput)}
        apiKeyOpen={showApiKeyInput}
      />
      <ApiKeyPanel visible={showApiKeyInput} />

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 space-y-4">
        {/* ì—ëŸ¬ */}
        {error && (
          <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex items-start gap-3">
            <svg className="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p className="text-sm text-red-700">{error}</p>
          </div>
        )}

        {/* ê²°ê³¼ í—¤ë” */}
        <div className="bg-white rounded-xl shadow-sm border border-emerald-200 p-5">
          <div className="flex items-center justify-between mb-3">
            <div>
              <h2 className="text-lg font-semibold text-gray-900">{result.title}</h2>
              <div className="flex items-center gap-4 mt-1">
                <span className="text-xs text-gray-500">
                  {result.metadata.wordCount.toLocaleString()}ì
                </span>
                <span className="text-xs text-gray-500">{result.metadata.estimatedReadTime}</span>
                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700 border border-emerald-200">
                  {categories.find(c => c.id === selectedCategory)?.label}
                </span>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={handleCopyTitle}
                className={`inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border hover:shadow-md hover:scale-[1.03] ${
                  copiedTitle
                    ? 'bg-emerald-500 text-white border-emerald-300'
                    : 'border-amber-300 bg-amber-50 text-amber-700 hover:bg-amber-100'
                }`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={copiedTitle ? 'M5 13l4 4L19 7' : 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z'} />
                </svg>
                {copiedTitle ? 'ë³µì‚¬ë¨!' : 'ì œëª© ë³µì‚¬'}
              </button>
              <button
                onClick={handleCopy}
                className={`inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border hover:shadow-md hover:scale-[1.03] ${
                  copied
                    ? 'bg-emerald-500 text-white border-emerald-300'
                    : 'border-sky-300 bg-sky-50 text-sky-700 hover:bg-sky-100'
                }`}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={copied ? 'M5 13l4 4L19 7' : 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z'} />
                </svg>
                {copied ? 'ë³µì‚¬ë¨!' : 'ë³¸ë¬¸ ë³µì‚¬'}
              </button>
              <button
                onClick={handleCopyAsImage}
                disabled={isCapturing}
                className={`inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border hover:shadow-md hover:scale-[1.03] disabled:opacity-50 ${
                  copiedImage
                    ? 'bg-emerald-500 text-white border-emerald-300'
                    : 'border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100'
                }`}
              >
                {isCapturing ? (
                  <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                ) : (
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={copiedImage ? 'M5 13l4 4L19 7' : 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z'} />
                  </svg>
                )}
                {copiedImage ? 'ë³µì‚¬ë¨!' : isCapturing ? 'ìº¡ì²˜ ì¤‘...' : 'ì´ë¯¸ì§€ë¡œ ë³µì‚¬'}
              </button>
              <button
                onClick={handleReset}
                className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border border-violet-300 bg-gray-50 text-gray-600 hover:bg-gray-100 hover:shadow-md hover:scale-[1.03]"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                ìƒˆë¡œ ë§Œë“¤ê¸°
              </button>
            </div>
          </div>

          {/* SEO íŒ */}
          {result.metadata.seoTips.length > 0 && (
            <div className="bg-blue-50 rounded-xl p-3 border border-blue-200">
              <h3 className="text-sm font-semibold text-blue-800 mb-1.5 flex items-center gap-1.5">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                GEO/AIO SEO íŒ
              </h3>
              <ul className="space-y-1">
                {result.metadata.seoTips.map((tip, i) => (
                  <li key={i} className="text-xs text-blue-700 flex items-start gap-1.5">
                    <span className="text-blue-400 mt-0.5">&#8226;</span>
                    {tip}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>

        {/* ìˆ˜ì • ì…ë ¥ì°½ */}
        {showEditInput && (
          <div className="bg-violet-50 rounded-xl shadow-sm border border-violet-300 p-4">
            <div className="flex items-center gap-2 mb-3">
              <svg className="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              <h4 className="text-sm font-semibold text-violet-800">ì½˜í…ì¸  ìˆ˜ì • ìš”ì²­</h4>
            </div>
            <textarea
              value={editNotes}
              onChange={(e) => setEditNotes(e.target.value)}
              placeholder="ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆ: 'ì„œë¡ ì„ ë” ê°•ë ¬í•˜ê²Œ', 'í†µê³„ ë°ì´í„° ì¶”ê°€', 'FAQ ì„¹ì…˜ ë³´ê°•'"
              rows={3}
              className="w-full px-4 py-3 border border-violet-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-violet-400 focus:border-transparent placeholder-gray-400 resize-none bg-white"
            />
            <button
              onClick={handleRegenerate}
              disabled={isRegenerating || !editNotes.trim()}
              className="mt-3 w-full py-3 bg-gradient-to-r from-violet-600 to-purple-600 text-white font-medium rounded-xl hover:from-violet-700 hover:to-purple-700 hover:shadow-lg hover:scale-[1.01] transition-all duration-200 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed border border-violet-300 flex items-center justify-center gap-2"
            >
              {isRegenerating ? (
                <>
                  <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                  ìˆ˜ì • ë°˜ì˜í•˜ì—¬ ì¬ìƒì„± ì¤‘...
                </>
              ) : (
                <>
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  ì¬ìƒì„±
                </>
              )}
            </button>
          </div>
        )}

        {/* ìƒì„±ëœ ì½˜í…ì¸  */}
        <div className="bg-white rounded-xl shadow-sm border border-indigo-200 p-5 relative">
          {/* ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ */}
          <div className="absolute top-4 right-4 flex items-center gap-2">
            <button
              onClick={() => {
                if (!contentRef.current) return;
                const html = contentRef.current.innerHTML;
                const text = contentRef.current.innerText;
                const blob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([text], { type: 'text/plain' });
                navigator.clipboard.write([
                  new ClipboardItem({
                    'text/html': blob,
                    'text/plain': textBlob,
                  }),
                ]).then(() => {
                  setCopiedContent(true);
                  setTimeout(() => setCopiedContent(false), 2000);
                });
              }}
              className={`inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-all duration-200 border hover:shadow-md hover:scale-105 ${
                copiedContent
                  ? 'bg-emerald-500 text-white border-emerald-300'
                  : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100 hover:border-indigo-300'
              }`}
            >
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={copiedContent ? 'M5 13l4 4L19 7' : 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z'} />
              </svg>
              {copiedContent ? 'ë³µì‚¬ë¨!' : 'ë³µì‚¬'}
            </button>
            <button
              onClick={() => setShowEditInput(!showEditInput)}
              className={`inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-all duration-200 border hover:shadow-md hover:scale-105 ${
                showEditInput
                  ? 'bg-violet-500 text-white border-violet-300'
                  : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-gray-100 hover:border-violet-300'
              }`}
            >
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              ìˆ˜ì •
            </button>
          </div>
          <div className="prose prose-sm max-w-none" ref={contentRef}>
            <div
              className="text-sm text-gray-800 leading-relaxed"
              dangerouslySetInnerHTML={{
                __html: markdownToHtml(result.content)
              }}
            />
            {/* í•´ì‹œíƒœê·¸ - ë³¸ë¬¸ ì•ˆì— í¬í•¨í•˜ì—¬ ë³µì‚¬ ì‹œ í•¨ê»˜ ë³µì‚¬ë¨ */}
            {result.hashtags && result.hashtags.length > 0 && (
              <div className="mt-5 pt-3 flex flex-wrap gap-2">
                {result.hashtags.map((tag, i) => (
                  <span key={i} className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-100 hover:scale-105 transition-all duration-200 cursor-default">
                    {tag.startsWith('#') ? tag : `#${tag}`}
                  </span>
                ))}
              </div>
            )}
          </div>

          {/* AI ì´ë¯¸ì§€ ìƒì„± */}
          <div className="mt-4 pt-3 border-t border-gray-200">
            {generatedImages.length === 0 ? (
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span className="text-sm font-semibold text-gray-700">AI ì´ë¯¸ì§€ ìƒì„±</span>
                  <span className="text-xs text-gray-400">Geminië¡œ ì½˜í…ì¸  ê´€ë ¨ ì´ë¯¸ì§€ 3ì¥ì„ ìƒì„±í•©ë‹ˆë‹¤</span>
                </div>
                <button
                  onClick={handleGenerateImages}
                  disabled={isGeneratingImages}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border bg-gradient-to-r from-emerald-500 to-teal-500 text-white border-emerald-300 hover:from-emerald-600 hover:to-teal-600 hover:shadow-lg hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                >
                  {isGeneratingImages ? (
                    <>
                      <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                      </svg>
                      ìƒì„± ì¤‘...
                    </>
                  ) : (
                    <>
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      ì´ë¯¸ì§€ 3ì¥ ìƒì„±
                    </>
                  )}
                </button>
              </div>
            ) : (
              <div>
                <div className="flex items-center justify-between mb-3">
                  <span className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                    <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    AI ìƒì„± ì´ë¯¸ì§€ ({generatedImages.length}ì¥)
                  </span>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={handleApplyImages}
                      className="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-semibold rounded-xl transition-all duration-200 border border-indigo-300 text-white bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 hover:shadow-lg hover:scale-105 shadow-sm"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      ë³¸ë¬¸ì— ì‚½ì…
                    </button>
                    <button
                      onClick={handleGenerateImages}
                      disabled={isGeneratingImages}
                      className="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-all duration-200 border border-emerald-300 text-emerald-700 bg-emerald-50 hover:bg-emerald-100 hover:shadow-md hover:scale-105 disabled:opacity-50"
                    >
                      {isGeneratingImages ? (
                        <>
                          <svg className="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                          </svg>
                          ì¬ìƒì„± ì¤‘...
                        </>
                      ) : 'ë‹¤ì‹œ ìƒì„±'}
                    </button>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                  {generatedImages.map((img, i) => (
                    <div key={i} className="relative group rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-lg transition-all duration-200">
                      <img src={img} alt={`AI ìƒì„± ì´ë¯¸ì§€ ${i + 1}`} className="w-full aspect-video object-cover" />
                      <div className="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all duration-200 flex items-center justify-center">
                        <a
                          href={img}
                          download={`ai-image-${i + 1}.png`}
                          className="opacity-0 group-hover:opacity-100 inline-flex items-center gap-1.5 px-3 py-1.5 bg-white/90 text-gray-800 text-xs font-medium rounded-lg shadow-md hover:bg-white transition-all"
                        >
                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                          ë‹¤ìš´ë¡œë“œ
                        </a>
                      </div>
                      <div className="absolute top-2 left-2 bg-black/50 text-white text-[10px] font-bold px-2 py-0.5 rounded-md">
                        {i + 1}/{generatedImages.length}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            {imageError && (
              <div className="mt-3 bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-2">
                <svg className="w-4 h-4 text-red-500 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="text-xs text-red-700">{imageError}</p>
              </div>
            )}
          </div>

          {/* A/B ë²„ì „ ë¹„êµ */}
          {abVersions.length > 1 && (
            <div className="bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden">
              <div className="bg-gradient-to-r from-amber-50 to-orange-50 px-5 py-2 border-b border-amber-200">
                <h3 className="text-sm font-bold text-amber-800 flex items-center gap-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>
                  A/B ë²„ì „ ë¹„êµ ({abVersions.length}ê°œ ë²„ì „)
                </h3>
              </div>
              <div className="flex border-b border-amber-100">
                {abVersions.map((v, i) => (
                  <button
                    key={i}
                    onClick={() => { setActiveAbTab(i); setResult(v); }}
                    className={`flex-1 px-4 py-2.5 text-xs font-semibold transition-all ${
                      activeAbTab === i
                        ? 'bg-amber-500 text-white'
                        : 'text-amber-700 hover:bg-amber-50'
                    }`}
                  >
                    {v.toneName || `ë²„ì „ ${i + 1}`}
                  </button>
                ))}
              </div>
              <div className="p-4">
                <p className="text-xs text-amber-600">ìœ„ íƒ­ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë²„ì „ì˜ ì½˜í…ì¸ ë¡œ ì „í™˜ë©ë‹ˆë‹¤. ê° ë²„ì „ì„ ë¹„êµí•œ í›„ ê°€ì¥ ì í•©í•œ ë²„ì „ì„ ì„ íƒí•˜ì„¸ìš”.</p>
              </div>
            </div>
          )}

          {/* SNS ì±„ë„ë³„ ë³€í™˜ */}
          <div className="bg-white rounded-xl shadow-sm border border-teal-200 overflow-hidden">
            <div className="bg-gradient-to-r from-teal-50 to-cyan-50 px-5 py-2 border-b border-teal-200">
              <h3 className="text-sm font-bold text-teal-800 flex items-center gap-2">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                SNS ì±„ë„ë³„ ë³€í™˜
              </h3>
            </div>
            <div className="p-3">
              <div className="flex flex-wrap gap-2 mb-3">
                {[
                  { id: 'instagram', label: 'ì¸ìŠ¤íƒ€ê·¸ë¨', icon: 'ğŸ“¸', color: 'pink' },
                  { id: 'linkedin', label: 'ë§í¬ë“œì¸', icon: 'ğŸ’¼', color: 'blue' },
                  { id: 'naver_blog', label: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸', icon: 'ğŸ“', color: 'green' },
                  { id: 'card_news', label: 'ì¹´ë“œë‰´ìŠ¤', icon: 'ğŸ´', color: 'purple' },
                  { id: 'summary', label: 'í•µì‹¬ ìš”ì•½', icon: 'ğŸ“‹', color: 'amber' },
                ].map(ch => (
                  <button
                    key={ch.id}
                    onClick={() => handleSnsConvert(ch.id)}
                    disabled={snsLoading}
                    className={`inline-flex items-center gap-1.5 px-3 py-2 text-xs font-semibold rounded-xl border transition-all hover:shadow-md hover:scale-105 disabled:opacity-50 ${
                      snsChannel === ch.id
                        ? `bg-${ch.color}-500 text-white border-${ch.color}-300`
                        : `bg-${ch.color}-50 text-${ch.color}-700 border-${ch.color}-200 hover:bg-${ch.color}-100`
                    }`}
                  >
                    <span>{ch.icon}</span>
                    {ch.label}
                  </button>
                ))}
              </div>
              {snsLoading && (
                <div className="flex items-center gap-2 text-sm text-teal-600 py-4">
                  <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                  ë³€í™˜ ì¤‘...
                </div>
              )}
              {snsResult && !snsLoading && (
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-xs font-semibold text-gray-600">ë³€í™˜ ê²°ê³¼</span>
                    <button
                      onClick={handleCopySns}
                      className={`inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium rounded-lg border transition-all ${
                        snsCopied ? 'bg-emerald-500 text-white border-emerald-300' : 'bg-teal-50 text-teal-700 border-teal-200 hover:bg-teal-100'
                      }`}
                    >
                      {snsCopied ? 'ë³µì‚¬ë¨!' : 'ë³µì‚¬'}
                    </button>
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 border border-gray-200 text-sm text-gray-800 whitespace-pre-wrap max-h-96 overflow-y-auto">
                    {snsResult}
                  </div>
                </div>
              )}
            </div>
          </div>

        </div>
      </main>

      <Footer />

      {/* ìµœì¢… ì½˜í…ì¸  ëª¨ë‹¬ (ì´ë¯¸ì§€ + ê¸€) */}
      {showFinalContent && (
        <div className="fixed inset-0 z-50 flex items-start justify-center bg-black/50 backdrop-blur-sm overflow-y-auto p-3 sm:p-6">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl my-4">
            <div className="sticky top-0 bg-white border-b border-gray-200 rounded-t-2xl px-6 py-4 flex items-center justify-between z-10">
              <div className="flex items-center gap-3">
                <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <h3 className="text-lg font-bold text-gray-900">ìµœì¢… ì½˜í…ì¸ </h3>
                <span className="text-xs text-gray-400">ê¸€ + ì¸í¬ê·¸ë˜í”½ ì´ë¯¸ì§€</span>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={handleCopyFinalContent}
                  className={`inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-xl transition-all duration-200 border hover:shadow-md hover:scale-105 ${
                    copiedFinal
                      ? 'bg-emerald-500 text-white border-emerald-300'
                      : 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white border-indigo-300 hover:from-indigo-600 hover:to-purple-700'
                  }`}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={copiedFinal ? 'M5 13l4 4L19 7' : 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z'} />
                  </svg>
                  {copiedFinal ? 'ë³µì‚¬ë¨!' : 'ë¸”ë¡œê·¸ì— ë¶™ì—¬ë„£ê¸°ìš© ë³µì‚¬'}
                </button>
                <button
                  onClick={() => setShowFinalContent(false)}
                  className="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-all"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  ë‹«ê¸°
                </button>
              </div>
            </div>
            <div className="px-5 py-6" ref={finalContentRef}>
              <div
                className="prose prose-sm max-w-none text-gray-800 leading-relaxed"
                style={{ lineHeight: '1.8' }}
                dangerouslySetInnerHTML={{ __html: finalContentHtml }}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
